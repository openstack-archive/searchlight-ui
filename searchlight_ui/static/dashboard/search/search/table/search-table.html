<hz-page-header header="{$ 'Search' | translate $}">
  <p translate>
    Find your cloud resources by selecting specific facets or by specifying
    full text search queries.
    <a href=""
       ng-controller="searchSyntaxController as syntaxCtrl"
       ng-click="syntaxCtrl.show()">
      <span class="fa fa-question-circle"></span>
    </a>
  </p>
</hz-page-header>

<table hz-table ng-cloak ng-controller="searchTableController as table"
       st-table="table.hits"
       st-safe-src="table.hitsSrc"
       class="table table-striped table-hover table-rsp table-detail">

  <thead>
  <tr>
    <th colspan="100" class="search-header">
      <div class="row">
      <hack-magic-search-bar class="col-md-10"
        filter-facets="table.searchFacets"
        client-full-text-search="false"
        search-settings-callback="table.searchSettings.open">
      </hack-magic-search-bar>
      <actions class="col-md-2" allowed="table.registry.getGlobalActions" type="row">
      </actions>
      </div>
    </th>
    <!-- th colspan="1" class="table_caption">
      <a href="" ng-click="table.refresh()"
         tooltip="{$ 'Refresh results' | translate $}"
         tooltip-placement="top" tooltip-trigger="mouseenter" class="btn btn-default">
        <span class="fa fa-refresh"></span>
      </a>
    <th -->
  </tr>
  <tr>
    <!--
      Please note, search result sorting should not be done client side.
      Searchlight will provide the proper default sorting based on search
      result scoring.
    -->
    <th class="expander"></th>


    <th class="rsp-p1" translate>Type</th>
    <th ng-if="table.searchSettings.settings.general.all_projects"
        class="rsp-p1"
        translate>
      Project
    </th>
    <th class="rsp-p1" translate>Name</th>
    <th class="rsp-p2" translate>Status</th>
    <th class="rsp-p2" translate>Visibility</th>
    <th class="rsp-p2" translate>Updated</th>
    <th class="rsp-p2" translate>Field Matches</th>
    <!-- th class="rsp-p3" translate>Description</th -->
    <th class="actions_column" translate>Actions</th>
  </tr>
  </thead>

  <tbody>

  <tr ng-if='table.queryResponse.error'>
    <td colspan="8" translate>
      {$ table.queryResponse.statusCode | queryStatus $}
    </td>
  </tr>

  <tr ng-if='!table.queryError'
      ng-repeat-start="hit in table.hits track by table.getSearchlightKey(hit)"
      ng-class="{incache: hit.dirty}">
    <td class="expander">
      <i class="fa fa-chevron-right"
         hz-expand-detail
         duration="200">
      </i>
    </td>

    <!-- TODO Truncate not working because not in fixed container -->
    <!-- TODO ng-cloak not working -->
    <!-- TODO consider adding spinner when search is happening... -->
    <td class="rsp-p1 truncate">{$ hit._type | resourceLabeler $}</td>
    <td ng-if="table.searchSettings.settings.general.all_projects"
        class="rsp-p1">
      <span tooltip="{$ hit._source.project_id $}"
            tooltip-placement="top"
            tooltip-popup-delay="500"
            tooltip-trigger="mouseenter">
        {$ hit._source.project_id | keystoneProjectName | noValue$}
      </span>
    </td>

    <td ng-cloak class="rsp-p1">
      <a ng-href="{$ 'project/ngdetails/' + hit._type + '/' + table.registry.getResourceType(hit._type).pathGenerator(hit._source.id) $}">
        <hz-search-highlighter hit="hit"
                               field="'name'"
                               default-value="hit._source.name || hit._source.id | noValue">
        </hz-search-highlighter>
      </a>
    </td>

    <td class="rsp-p2">{$ hit._source.status | commonStatus | noValue $}</td>

    <td class="rsp-p2">
      <span tooltip="{$ 'Visibility is based on derived data. If Owned by Me, please inspect the resource to determine sharing status.' | translate $}"
            tooltip-placement="top"
            tooltip-popup-delay="500"
            tooltip-trigger="mouseenter">
        {$ hit._type | commonVisibility: hit._source:table.userSession.project_id | noValue $}
      </span>
    </td>

    <td class="rsp-p2">{$ hit._source.updated_at | date:'short' | noValue $}</td>
    <td class="rsp-p2">
      <ul class="list-unstyled" ng-repeat="(field, value) in hit.highlight">
        <li ng-if="!field.endsWith('.raw')">
          {$ hit._type | resourceLabeler: field $}
        </li>
      </ul>
    </td>
    <!-- td class="rsp-p3 truncate">
      <hz-search-highlighter hit="hit"
                             field="'description'"
                             default-value="hit._source.description | noValue">
      </hz-search-highlighter>
    </td -->

    <td class="actions_column">
      <actions allowed="table.registry.getResourceType(hit._type).itemActions"
               type="row"
               item="hit._source"
               result-handler="table.actionResultHandler">
      </actions>
    </td>

  </tr>

  <tr ng-repeat-end class="detail-row">
    <!--
      Detail-row:
      Contains detailed information on this item.
      Can be toggled using the chevron button.
      Ensure colspan is greater or equal to number of column-headers.
    -->
    <td class="detail" colspan="100">
      <hz-drawer hit="hit" item="hit._source" template-url="table.registry.getResourceType(hit._type).drawerTemplateUrl || table.registry.getDefaultDrawerTemplateUrl()"></hz-drawer>
    </td>
  </tr>

  </tbody>

  <tfoot hz-table-footer items="table.hits"></tfoot>

</table>
